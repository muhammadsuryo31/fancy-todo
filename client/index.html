<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./style/index.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <title>Document</title>
    
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
          <a class="navbar-brand" href="#" id="nav-main">Fancy Todo</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
              <a class="nav-link active" aria-current="page" href="#" id="nav-register">Register</a>
              <a class="nav-link active" href="#" id="nav-login">Login</a>
              <a class="nav-link active" href="#" id="nav-task">Task List</a>
              <a class="nav-link active" href="#" id="nav-logout">Logout</a>
            </div>
          </div>
        </div>
      </nav>

      <!-- Regristration form -->
      <div id="register-form">
          <h1>Register</h1>
          <form id="register">
              <div class="mb-3">
                <label for="formGroupExampleInput" class="form-label">Email</label>
                <input type="email" class="form-control" id="register-email" placeholder="example@mail.com">
              </div>
              <div class="mb-3">
                <label for="formGroupExampleInput2" class="form-label">Password</label>
                <input type="text" class="form-control" id="register-password" placeholder="must contain 6 (six) or more characters">
              </div>
              <div>
                <button type="submit" class="btn btn-outline-primary" id="register-submit">Submit</button>
              </div>
          </form>
      </div>

      <!-- Login form -->
      <div id="login-form">
        <h1>Login</h1>
        <form id="login">
            <div class="mb-3">
              <label for="formGroupExampleInput" class="form-label">Email</label>
              <input type="email" class="form-control" id="login-email" placeholder="example@mail.com">
            </div>
            <div class="mb-3">
              <label for="formGroupExampleInput2" class="form-label">Password</label>
              <input type="text" class="form-control" id="login-password" placeholder="must contain 6 (six) or more characters">
            </div>
            <div>
              <button type="submit" class="btn btn-outline-primary" id="login-submit">Submit</button>
            </div>
        </form>
    </div>

    <!-- Todo form -->
    <div id="todo-form">
        <h1>Input Task</h1>
        <form id="todo">
            <div class="mb-3">
              <label for="formGroupExampleInput" class="form-label">Title</label>
              <input type="email" class="form-control" id="todo-title" placeholder="cooking for dinner">
            </div>
            <div class="mb-3">
              <label for="formGroupExampleInput2" class="form-label">Task description</label>
              <input type="text" class="form-control" id="todo-description" placeholder="cook a meal for dinner tonight">
            </div>
            <div class="mb-3">
                <label for="formGroupExampleInput2" class="form-label">Due Date</label>
                <input type="date" class="form-control" id="date-todo">
            </div>
            <div>
              <button type="submit" class="btn btn-outline-primary" id="login-submit">Submit</button>
            </div>
        </form>
    </div>

    <!-- todo table -->
    <table class="table" id="todo-table">
        <thead>
          <tr>
            <th>No</th>
            <th>Title</th>
            <th>Description</th>
            <th>Status</th>
            <th>Due Date</th>
            <th colspan="3">Action</th>
          </tr>
        </thead>
        </tbody>
      </table>

      
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script>
        const baseUser = "http://localhost:3000/users/";
        const baseTodo = "http://localhost:3000/todos"

        function authenticate(){
            if (!localStorage.getItem("access_token")){
                $("#regsiter-form").show();
                $("#login-form").hide()
                $("#todo-form").hide()
                $("#todo-table").hide()
                $("#nav-logout").hide()
                $("#nav-task").hide()
            } else {
                $("#register-form").hide();
                $("#login-form").hide()
                $("#nav-login").hide()
                $("#nav-register").hide()
                $("#todo-form").show()
                $("#todo-table").hide()
                $("#nav-logout").show()
                $("#nav-task").show()

            }
        }

        function register(){
            const email = $("#register-email").val();
            const password = $("#register-password").val()
            $.ajax({
                url: baseUser + "register",
                method: "POST",
                data: {
                    email,
                    password
                }
            })
                .done((response) => {
                    console.log(response);
                    $("p").remove(".error-message");
                    $("p").remove(".success-message");
                    $("#register").prepend(`<p class="success-message"><b style="color: green;">${response.msg}</b></p>`);
                })
                .fail ((xhr, text) => {
                    let error = xhr.responseJSON.message[0]
                    $("p").remove(".error-message");
                    $("#register").prepend(`<p class="error-message"><b style="color: red;">${error}</b></p>`);
                })
                .always(() => {
                    $("#register").trigger("reset");
                })
        }

        function login(){
            const email = $("#login-email").val();
            const password = $("#login-password").val()
            $.ajax({
                url: baseUser + "login",
                method: "POST",
                data: {
                    email,
                    password
                }
            })
                .done((response) => {
                    localStorage.setItem("access_token", response.access_token)
                    authenticate()
                })
                .fail ((xhr, text) => {
                    let error = xhr.responseJSON.message[0]
                    console.log(error);
                    $("p").remove(".error-message");
                    $("#login").prepend(`<p class="error-message"><b style="color: red;">${error}</b></p>`);
                })
                .always(() => {
                    $("#login").trigger("reset");
                })
        }

        function getTodo() {
            $.ajax({
                url: baseTodo,
                method: "GET",
                headers: {
                    access_token: localStorage.getItem("access_token")
                }
            })
                .done((todo) => {
                    // $("#todo-table").empty();
                    // $("#todo-table").append(
                    //     `<thead>
                    //     <tr>
                    //         <th>No</th>
                    //         <th>Title</th>
                    //         <th>Description</th>
                    //         <th>Status</th>
                    //         <th>Due Date</th>
                    //         <th>Action</th>
                    //     </tr>
                    //     </thead>
                    //     <tbody>
                    //         ${todo.forEach((element,ind) => {
                    //             `<tr>
                    //             <td>${ind+1}</td>
                    //             <td>${element.title}</td>
                    //             <td>${element.description}</td>
                    //             <td>${element.status}</td>
                    //             <td>${element.due_date}</td>
                    //             <td><a class="navbar-brand" href="#" id="mark-done">Done</a></td>
                    //             <td><a class="navbar-brand" href="#" id="mark-edit">Edit</a></td>
                    //             <td><a class="navbar-brand" href="#" id="mark-delete">Delete</a></td>
                    //             </tr>`
                    //         })}
                    //     </tbody>`
                    // )
                    todo.forEach((element, indeks) => {
                        $("#todo-table").append(
                            `<tr>
                            <td>${indeks+1}</td>
                            <td>${element.title}</td>
                            <td>${element.description}</td>
                            <td>${element.status}</td>
                            <td>${element.due_date}</td>
                            <td><a class="nav-link" href="#" id="mark-done">Done</a></td>
                            <td><a class="nav-link" href="#" id="mark-edit">Edit</a></td>
                            <td><a class="nav-link" href="#" id="mark-delete">Delete</a></td>
                            </tr>`
                        )
                    });

                })
                .fail((xhr, text) => {
                    console.log(error);
                })
                .always(() => {
                    console.log("always");
                })
        }


        $(document).ready(() => {
            authenticate()
            $("#nav-register").on("click", (e) => {
                e.preventDefault()
                $("#register-form").show();
                $("#login-form").hide()
            })
            $("#nav-login").on("click", (e) => {
                e.preventDefault()
                $("#register-form").hide();
                $("#login-form").show()
            })
            $("#register").on("submit", (e) => {
                e.preventDefault()
                register()
            })
            $("#login").on("submit", (e) => {
                e.preventDefault()
                login()
            })
            $("#nav-task").on("click", (e) => {
                e.preventDefault();
                $("#todo-table").show()
                $("#todo-form").hide()
                getTodo();
            })
            $("#nav-main").on("click", (e) => {
                e.preventDefault();
                $("#todo-table").hide()
                $("#todo-form").show()
            })
        })
    </script>
</body>
</html>